apiVersion: v1
kind: Template
metadata:
  name: ${ARTIFACTORY_NAME}-template
  annotations:
    description: "Template to create Artifactory HA pre-install objects"
objects:

- apiVersion: v1
  kind: ServiceAccount
  metadata:
    labels:
      app: ${ARTIFACTORY_NAME}
    name: ${ARTIFACTORY_NAME}
- apiVersion: v1
  kind: ConfigMap
  metadata:
    labels:
      app: ${ARTIFACTORY_NAME}
    name: ${ARTIFACTORY_NAME}-bs
  data:
    binarystore.xml: |-
      <!-- File system replication -->
      <config version="2">
          <chain template="file-system"/>
      </config>

- apiVersion: v1
  data:
    installer-info.json: |
      {
        "productId": "JFrogInstaller_Helm_${ARTIFACTORY_NAME}-0.12.22",
        "features": [
        {
          "featureId": "AppVersion/${ARTIFACTORY_VERSION}"
        },
        {
          "featureId": "Installer/helm"
        },
        {
          "featureId": "Platform/kubernetes"
        }
        ]
      }
  kind: ConfigMap
  metadata:
    labels:
      app: ${ARTIFACTORY_NAME}
    name: ${ARTIFACTORY_NAME}-installer-info
- apiVersion: v1
  kind: Secret
  metadata:
    name: ${ARTIFACTORY_NAME}
    labels:
      app: ${ARTIFACTORY_NAME}
  type: Opaque
  stringData:
    master-key: ${ARTIFACTORY_MASTER_KEY}
- apiVersion: v1
  stringData:
    bootstrap.creds: ${ARTIFACTORY_ACCESS_ADMIN}${ARTIFACTORY_BOOTSTRAP_CREDS}
  kind: Secret
  metadata:
    name: ${ARTIFACTORY_NAME}-bootstrap-creds
    labels:
      app: ${ARTIFACTORY_NAME}
  type: Opaque

parameters:
- description: Artifactory name
  name: ARTIFACTORY_NAME
  value: "artifactory"
  required: true
- description: Artifactory DNS Suffix
  name: ARTIFACTORY_DNS_NAME
  value: "artifacts.pathfinder.gov.bc.ca"
  required: true
- description: Artifactory version
  name: ARTIFACTORY_VERSION
  value: "6.9.1"
  required: true
- description: Location for registry where Artifactory image exists
  name: ARTIFACTORY_IMAGE_REGISTRY
  value: docker.bintray.io/jfrog/artifactory-pro
  required: true
- description: Artifactory volume size
  name: ARTIFACTORY_PVC_SIZE
  value: 25Gi
  required: true
- description: Database host
  name: DATABASE_NAME
  value: postgresql-95-rhel7
  required: true
- description: Number of member nodes in addition to the primary node
  name: NUM_OF_MEMBERS
  required: true
- description: Database username
  name: APP_DB_USERNAME
- name: ARTIFACTORY_EXTRA_JAVA_OPTIONS
  description: Artifactory Extra Java Options
  displayName: Artifactory Extra Java Options
  value: "-Xms1g -Xmx2g"
- name: CPU_LIMIT
  description: Artifactory CPU Limit
  displayName: Artifactory CPU Limit
  value: "1"
  required: true
- name: MEMORY_REQUEST
  description: Artifactory Memory Request
  displayName: Artifactory Memory Request
  value: "2Gi"
  required: true
- name: MEMORY_LIMIT
  description: Artifactory Memory Limit
  displayName: Artifactory Memory Limit
  value: "3Gi"
  required: true
- name: CPU_REQUEST
  description: Artifactory CPU Request
  displayName: Artifactory CPU Request
  value: "500m"
  required: true
- name: ARTIFACTORY_MASTER_KEY
  description: Artifactory master key
  required: false
- name: ARTIFACTORY_ACCESS_ADMIN
  description: Artifactory access admin
  value: "access-admin@127.0.0.1="
  required: true
- name: ARTIFACTORY_BOOTSTRAP_CREDS
  description: Artifactory bootstrap creds
  generate: expression
  from: '[a-zA-Z0-9]{8}'
